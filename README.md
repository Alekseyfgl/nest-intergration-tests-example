### Тесты с автоматическим запуском Docker

```bash
# Запуск тестов с автоматическим запуском и остановкой Docker Compose 
# Путь к тестам передается через параметр --path
# Тесты запускаются асинхронно с использованием 8 параллельных процессов
# Docker запускается автоматически и ожидает 10 секунд для инициализации Redis
npm run test:with-docker --path=src/users --maxWorkers=8

# Запуск всех тестов
npm run test:with-docker
```

### Интеграционные и E2E тесты

```bash
# Запуск E2E тестов
npm run test:e2e

# Запуск интеграционных тестов
npm run test:integration

# Запуск интеграционных тестов с Docker
npm run test:integration:docker

# Запуск интеграционных тестов с Docker Compose
npm run test:integration:compose
```

## Примеры использования

### Тестирование отдельного модуля

```bash
# Тестирование модуля калькулятора
npm run test:path -- src/utils/calc

# Тестирование всех модулей в директории services
npm run test:path -- src/services
```

### Использование шаблонов путей

```bash
# Тестировать всё, что содержит "user" в пути
npm run test:path -- user

# Тестировать несколько директорий (с регулярным выражением)
npm run test:path -- "(src/utils|src/services)"
```

### Запуск Redis для интеграционных тестов

Для интеграционных тестов с Redis вы можете использовать Docker Compose:

```bash
# Запуск Redis на нестандартном порту через Docker Compose
docker compose up -d

# Запуск интеграционных тестов, ожидающих Redis на порту 6380
npm run test:integration

# Остановка Redis после тестирования
docker compose down
```

Или воспользуйтесь автоматическим запуском и остановкой:

```bash
# Автоматически запускает Docker Compose и запускает тесты
# Ожидает 10 секунд для инициализации Redis
npm run test:with-docker --path=src/users
```

#### Особенности тестирования с Redis

Интеграционные тесты, использующие Redis:

1. Автоматически управляют соединением с Redis
2. Имеют механизм повторных попыток подключения
3. Автоматически очищают тестовые данные между тестами
4. Запускают контейнеры в фоновом режиме и останавливают их после завершения

### Параллельное выполнение тестов

Изоляция тестов обеспечивается с помощью:

1. **Префиксов ключей**: Каждый тест использует свой префикс (`keyPrefix`)
2. **Отдельных баз данных**: Тесты работают в разных базах Redis (`redisDb`)

Пример настройки изоляции в коде теста:

```typescript
// В test-utils/redis-test-setup.ts есть утилита settingTest
const testSetup = await settingTest({
  keyPrefix: 'user_tests:', // Префикс для изоляции ключей
  redisDb: 1,               // Номер базы данных Redis
  debug: true               // Включить отладочные сообщения
});
```

### Отладка Redis в тестовой среде

Для проверки содержимого Redis во время выполнения тестов можно подключиться к тестовому Redis напрямую:

#### Подключение через Redis CLI

```bash
# Подключение к Redis, запущенному в Docker на порту 6380
redis-cli -p 6380

# Переключение на нужную базу данных (если используете изоляцию по базам)
> SELECT 1

# Просмотр всех ключей
> KEYS *

# Просмотр всех ключей с определенным префиксом (для изолированных тестов)
> KEYS user_test:*

# Просмотр значения конкретного ключа
> GET user_test:user:c8f2d445-bd84-4c4a-9f80-b4a70ce98321

# Удаление данных
> DEL user_test:user:c8f2d445-bd84-4c4a-9f80-b4a70ce98321
```

#### Подключение через Docker

Если Redis CLI не установлен на вашей машине, можно подключиться через контейнер:

```bash
# Подключение к Redis через сам контейнер
docker exec -it redis-test redis-cli

# Или подключиться с указанием хоста и порта
docker run --rm -it --network nest-test_app-network redis redis-cli -h redis-test
```

#### Redis Commander (веб-интерфейс)

После запуска тестов с Docker, веб-интерфейс для Redis автоматически доступен по адресу:

**http://localhost:8081**

Это самый удобный способ для просмотра и редактирования данных Redis во время отладки тестов.

#### Настройки для внешних клиентов Redis

Если вы используете сторонние клиенты для Redis:

1. **Подключение к Redis**:
   - Хост: `localhost`
   - Порт: `6380`
   - Пароль: не требуется
   
2. **Контейнеры и сеть**:
   - Название контейнера: `redis-test`
   - Внутренний порт: `6379`
   - Внешний порт: `6380`
   - Сеть Docker: `nest-test_app-network`

#### Просмотр контейнеров Docker

```bash
# Просмотр запущенных контейнеров
docker ps

# Просмотр логов Redis-контейнера
docker logs redis-test
```

## Структура тестов

- `*.spec.ts` - Модульные тесты (расположены рядом с тестируемыми файлами)
- `test/*.e2e-spec.ts` - E2E тесты
- `test/*.integration.spec.ts` - Интеграционные тесты
- `test/*.test.js`, `test/*.spec.js` - JavaScript тесты 
